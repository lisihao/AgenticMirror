# Agentic Mirror - 系统架构设计

> 版本: 1.0.0
> 日期: 2025-01-16

---

## 一、系统概览

### 1.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                          Agentic Mirror 系统架构                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │   用户交互层    │
                              │                 │
                              │  Mirror 设备   │◄────┐
                              │  Mobile App    │     │
                              │  Web Portal    │     │
                              └────────┬────────┘     │
                                       │              │
                    ┌──────────────────┼──────────────┼──────────────────┐
                    │                  │              │                  │
                    ▼                  ▼              │                  ▼
         ┌─────────────────┐  ┌─────────────────┐    │       ┌─────────────────┐
         │   API Gateway   │  │   WebSocket     │    │       │  CDN / 静态资源  │
         │   (Kong/APISIX) │  │   Server        │    │       │                 │
         └────────┬────────┘  └────────┬────────┘    │       └─────────────────┘
                  │                    │              │
                  └──────────┬─────────┘              │
                             │                        │
         ┌───────────────────┼───────────────────┐    │
         │                   │                   │    │
         ▼                   ▼                   ▼    │
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│  Auth Service   │ │  User Service   │ │ Device Service  │
│                 │ │                 │ │                 │
│ - JWT Token     │ │ - Profile       │ │ - 设备注册      │
│ - OAuth 2.0    │ │ - Settings      │ │ - OTA 升级      │
│ - 权限管理      │ │ - 偏好设置      │ │ - 状态同步      │
└─────────────────┘ └─────────────────┘ └────────┬────────┘
                                                  │
┌─────────────────────────────────────────────────┼─────────────────────────────┐
│                              AI 服务层          │                              │
├─────────────────────────────────────────────────┼─────────────────────────────┤
│                                                 │                              │
│  ┌─────────────────┐  ┌─────────────────┐  ┌───┴───────────┐                 │
│  │  Vision AI      │  │  Recommendation │  │  Trend        │                 │
│  │                 │  │  Engine         │  │  Analyzer     │                 │
│  │  - 面部识别     │  │                 │  │               │                 │
│  │  - 皮肤分析     │  │  - 妆容推荐     │  │  - 爬虫系统   │                 │
│  │  - 情绪检测     │  │  - 产品匹配     │  │  - 热点分析   │                 │
│  │  - 追踪算法     │  │  - 个性化排序   │  │  - 趋势预测   │                 │
│  │                 │  │                 │  │               │                 │
│  └─────────────────┘  └─────────────────┘  └───────────────┘                 │
│                                                                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌───────────────┐                 │
│  │  LLM Service    │  │  Tutorial       │  │  Health       │                 │
│  │                 │  │  Generator      │  │  Analyzer     │                 │
│  │  - GPT-4       │  │                 │  │               │                 │
│  │  - Claude      │  │  - 教程生成     │  │  - 健康评估   │                 │
│  │  - 对话理解    │  │  - 步骤拆解     │  │  - 周期分析   │                 │
│  │  - 意图识别    │  │  - 视频合成     │  │  - 趋势预警   │                 │
│  │                 │  │                 │  │               │                 │
│  └─────────────────┘  └─────────────────┘  └───────────────┘                 │
│                                                                               │
└───────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Commerce 服务层                                     │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐                 │
│  │  Product        │  │  Order          │  │  Payment        │                 │
│  │  Catalog        │  │  Service        │  │  Service        │                 │
│  │                 │  │                 │  │                 │                 │
│  │  - 商品管理     │  │  - 订单创建     │  │  - Stripe       │                 │
│  │  - 库存同步     │  │  - 物流追踪     │  │  - 支付宝       │                 │
│  │  - 价格策略     │  │  - 售后服务     │  │  - 微信支付     │                 │
│  │                 │  │                 │  │                 │                 │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘                 │
│                                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐                                      │
│  │  Inventory      │  │  Brand          │                                      │
│  │  Service        │  │  Portal         │                                      │
│  │                 │  │                 │                                      │
│  │  - 用户库存     │  │  - 品牌入驻     │                                      │
│  │  - 用量追踪     │  │  - 数据分析     │                                      │
│  │  - 补货提醒     │  │  - 营销工具     │                                      │
│  │                 │  │                 │                                      │
│  └─────────────────┘  └─────────────────┘                                      │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              数据存储层                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │ PostgreSQL  │  │   Redis     │  │   MongoDB   │  │   Qdrant    │           │
│  │             │  │             │  │             │  │             │           │
│  │ 用户数据    │  │ 缓存/会话   │  │ 日志/行为   │  │ 向量搜索    │           │
│  │ 订单数据    │  │ 实时状态    │  │ 非结构化    │  │ 相似推荐    │           │
│  │             │  │             │  │             │  │             │           │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘           │
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                             │
│  │    S3/OSS   │  │ ClickHouse  │  │   Kafka     │                             │
│  │             │  │             │  │             │                             │
│  │ 图片/视频   │  │ 数据分析    │  │ 消息队列    │                             │
│  │ 静态资源    │  │ 行为统计    │  │ 事件流     │                             │
│  │             │  │             │  │             │                             │
│  └─────────────┘  └─────────────┘  └─────────────┘                             │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────────┐
│                              外部集成层                                          │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │  小红书 API │  │  抖音 API   │  │  微博 API   │  │ HealthKit   │           │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘           │
│                                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐           │
│  │ 品牌供应链  │  │ 物流 API    │  │ 支付网关    │  │ 短信/推送   │           │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘           │
│                                                                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 二、设备端架构

### 2.1 硬件系统架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Mirror 设备硬件架构                                  │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────┐
                    │          主显示屏幕             │
                    │       (15.6" IPS 触控屏)        │
                    │          1920x1080              │
                    └─────────────────────────────────┘
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        │                           │                           │
        ▼                           ▼                           ▼
┌───────────────┐          ┌───────────────┐          ┌───────────────┐
│  摄像头模组   │          │   主控单元    │          │   云台系统    │
│               │          │               │          │               │
│ - 4K RGB Cam │          │ - RK3588     │          │ - 2轴云台     │
│ - IR Camera  │          │ - 8GB RAM    │          │ - 步进电机    │
│ - ToF 传感器 │          │ - 64GB eMMC  │          │ - 角度传感器  │
│               │          │ - NPU 6TOPS  │          │               │
└───────┬───────┘          └───────┬───────┘          └───────┬───────┘
        │                          │                          │
        │                          │                          │
        ▼                          ▼                          ▼
┌───────────────┐          ┌───────────────┐          ┌───────────────┐
│   补光系统    │          │   音频系统    │          │   连接模块    │
│               │          │               │          │               │
│ - LED 环形灯 │          │ - 麦克风阵列 │          │ - WiFi 6     │
│ - 可调色温   │          │ - 扬声器     │          │ - BLE 5.0    │
│ - 亮度调节   │          │ - 降噪处理   │          │ - USB-C      │
│               │          │               │          │               │
└───────────────┘          └───────────────┘          └───────────────┘
```

### 2.2 固件架构

```
┌─────────────────────────────────────────────────────────────────┐
│                     固件软件架构                                 │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                    Application Layer                             │
│                                                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ Face     │  │ Skin     │  │ Tutorial │  │ Commerce │        │
│  │ Tracking │  │ Analysis │  │ Player   │  │ Client   │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│                    AI Inference Layer                            │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │              RKNN Runtime (NPU Acceleration)              │   │
│  │                                                           │   │
│  │  - Face Detection Model    - Skin Analysis Model         │   │
│  │  - Face Landmark Model     - Emotion Recognition         │   │
│  │  - Face Tracking Model     - Gesture Recognition         │   │
│  │                                                           │   │
│  └──────────────────────────────────────────────────────────┘   │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│                    Middleware Layer                              │
│                                                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ Camera   │  │ Motor    │  │ Network  │  │ Storage  │        │
│  │ Manager  │  │ Control  │  │ Manager  │  │ Manager  │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
│                                                                  │
├─────────────────────────────────────────────────────────────────┤
│                    OS Layer (Linux/Android)                      │
│                                                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ V4L2     │  │ GPIO/I2C │  │ WiFi/BLE │  │ Display  │        │
│  │ Driver   │  │ Driver   │  │ Stack    │  │ Driver   │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 三、数据流架构

### 3.1 实时数据流

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           实时数据流架构                                     │
└─────────────────────────────────────────────────────────────────────────────┘

  Mirror 设备                    云端服务                      外部数据源
      │                            │                              │
      │  ┌──────────────────────┐  │                              │
      │  │ 1. 摄像头采集        │  │                              │
      │  │    - RGB 图像        │  │                              │
      │  │    - IR 图像         │  │                              │
      │  └──────────┬───────────┘  │                              │
      │             │              │                              │
      │  ┌──────────▼───────────┐  │                              │
      │  │ 2. 本地 AI 推理      │  │                              │
      │  │    - 人脸检测        │  │                              │
      │  │    - 追踪算法        │  │                              │
      │  │    - 皮肤初筛        │  │                              │
      │  └──────────┬───────────┘  │                              │
      │             │              │                              │
      │             │ WebSocket    │                              │
      │             ▼              │                              │
      │  ┌─────────────────────────┴─────────────────────────┐    │
      │  │                     API Gateway                    │    │
      │  └─────────────────────────┬─────────────────────────┘    │
      │                            │                              │
      │             ┌──────────────┼──────────────┐               │
      │             │              │              │               │
      │             ▼              ▼              ▼               │
      │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
      │  │ 云端深度    │  │ 推荐引擎    │  │ 潮流分析    │◄──────┤
      │  │ 分析服务    │  │             │  │ 服务        │       │
      │  │             │  │ - 妆容匹配  │  │             │       │
      │  │ - 皮肤报告 │  │ - 产品推荐  │  │ - 小红书    │       │
      │  │ - 健康评估 │  │ - 教程生成  │  │ - 抖音      │       │
      │  │             │  │             │  │ - 微博      │       │
      │  └──────┬──────┘  └──────┬──────┘  └─────────────┘       │
      │         │                │                                │
      │         └────────┬───────┘                                │
      │                  │                                        │
      │                  ▼                                        │
      │  ┌─────────────────────────────────────────────────┐     │
      │  │              Response Aggregator                 │     │
      │  │                                                  │     │
      │  │  - 合并分析结果                                  │     │
      │  │  - 生成推荐方案                                  │     │
      │  │  - 构建教程序列                                  │     │
      │  │                                                  │     │
      │  └──────────────────────┬──────────────────────────┘     │
      │                         │                                 │
      │◄────────────────────────┘                                 │
      │                                                           │
      │  ┌──────────────────────┐                                │
      │  │ 3. 渲染展示          │                                │
      │  │    - AR 叠加         │                                │
      │  │    - 教程播放        │                                │
      │  │    - 产品卡片        │                                │
      │  └──────────────────────┘                                │
      │                                                           │
```

### 3.2 数据同步策略

| 数据类型 | 同步方式 | 频率 | 存储位置 |
|----------|----------|------|----------|
| 面部特征 | 实时上传 | 每帧 | 云端临时 |
| 皮肤分析结果 | 批量同步 | 每次分析 | 云端持久化 |
| 用户偏好 | 增量同步 | 变更时 | 云端 + 本地 |
| 教程视频 | 预加载 | 按需 | 本地缓存 |
| 产品目录 | 定时拉取 | 每日 | 本地缓存 |
| 潮流数据 | 推送 | 实时 | 云端 |

---

## 四、AI 模型架构

### 4.1 模型部署策略

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           AI 模型部署架构                                    │
└─────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────┐
                    │           Edge Models           │
                    │         (设备端部署)            │
                    │                                 │
                    │  - Face Detection (YOLO)       │
                    │  - Face Landmark (MediaPipe)   │
                    │  - Face Tracking (DeepSORT)    │
                    │  - Basic Skin Analysis         │
                    │                                 │
                    │  延迟: <50ms                    │
                    │  模型大小: <100MB               │
                    └───────────────┬─────────────────┘
                                    │
                                    │ 特征向量 + 图像
                                    ▼
                    ┌─────────────────────────────────┐
                    │          Cloud Models           │
                    │         (云端部署)              │
                    │                                 │
                    │  - Deep Skin Analysis (CNN)    │
                    │  - Emotion Recognition          │
                    │  - Makeup Style Transfer       │
                    │  - Product Matching (RecSys)   │
                    │  - Trend Prediction (LSTM)     │
                    │                                 │
                    │  延迟: <500ms                   │
                    │  GPU: A100/H100                │
                    └───────────────┬─────────────────┘
                                    │
                                    │ 复杂推理
                                    ▼
                    ┌─────────────────────────────────┐
                    │           LLM Layer             │
                    │        (大语言模型)             │
                    │                                 │
                    │  - GPT-4 (对话/推荐解释)       │
                    │  - Claude (长文本生成)         │
                    │  - Gemini (多模态理解)         │
                    │                                 │
                    │  场景:                          │
                    │  - 个性化推荐语生成             │
                    │  - 教程脚本生成                 │
                    │  - 用户对话理解                 │
                    │                                 │
                    └─────────────────────────────────┘
```

### 4.2 模型列表

| 模型 | 用途 | 部署位置 | 框架 | 精度 |
|------|------|----------|------|------|
| YOLOv8-Face | 人脸检测 | Edge | RKNN | INT8 |
| MediaPipe Face Mesh | 面部关键点 | Edge | TFLite | FP16 |
| DeepSORT | 人脸追踪 | Edge | ONNX | FP32 |
| SkinNet | 皮肤分析 | Cloud | PyTorch | FP16 |
| EmotionNet | 情绪识别 | Cloud | PyTorch | FP16 |
| MakeupGAN | 妆容迁移 | Cloud | PyTorch | FP16 |
| ProductRec | 产品推荐 | Cloud | PyTorch | FP32 |
| TrendLSTM | 趋势预测 | Cloud | PyTorch | FP32 |

---

## 五、安全架构

### 5.1 数据安全

```
┌─────────────────────────────────────────────────────────────────┐
│                        安全架构                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      传输层安全                                  │
│                                                                  │
│  - TLS 1.3 加密传输                                             │
│  - Certificate Pinning                                          │
│  - WebSocket Secure (WSS)                                       │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      数据加密                                    │
│                                                                  │
│  - 面部数据: AES-256 加密存储                                   │
│  - 本地缓存: 设备级加密                                         │
│  - 云端存储: 服务端加密 (SSE)                                   │
│  - 数据库: 字段级加密 (敏感信息)                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      隐私保护                                    │
│                                                                  │
│  - 面部特征向量化，不存储原始图像                               │
│  - 本地处理优先，减少数据上传                                   │
│  - 用户可随时删除个人数据                                       │
│  - GDPR / 个人信息保护法 合规                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                      访问控制                                    │
│                                                                  │
│  - OAuth 2.0 + PKCE 认证                                        │
│  - JWT Token (短有效期)                                         │
│  - 设备绑定 (Device Attestation)                                │
│  - 生物识别登录 (Face ID / 指纹)                                │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 5.2 合规要求

| 法规 | 要求 | 实现方式 |
|------|------|----------|
| GDPR | 数据可携带权 | 提供数据导出功能 |
| GDPR | 被遗忘权 | 一键删除所有数据 |
| 个人信息保护法 | 最小必要原则 | 按需收集，明确告知 |
| 个人信息保护法 | 知情同意 | 弹窗授权，可撤回 |

---

## 六、技术选型

### 6.1 技术栈总览

| 层级 | 技术选型 | 备注 |
|------|----------|------|
| 设备主控 | RK3588 (Linux) | 高性能 NPU |
| 设备应用 | Qt/QML | 跨平台 UI |
| Mobile App | Flutter | iOS + Android |
| Web Portal | Next.js 14 | 管理后台 |
| API Gateway | Kong | 限流/认证 |
| 后端服务 | Python FastAPI | 高性能异步 |
| AI 推理 | PyTorch + RKNN | 云端 + 边缘 |
| 数据库 | PostgreSQL | 主数据库 |
| 缓存 | Redis | 会话/缓存 |
| 向量数据库 | Qdrant | 相似推荐 |
| 对象存储 | MinIO / S3 | 图片/视频 |
| 消息队列 | Kafka | 事件驱动 |
| 容器编排 | Kubernetes | 云原生部署 |

---

## 七、部署架构

### 7.1 云端部署

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Kubernetes 集群                                    │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  Ingress (Nginx)                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        │                           │                           │
        ▼                           ▼                           ▼
┌───────────────────┐    ┌───────────────────┐    ┌───────────────────┐
│   API Services    │    │   AI Services     │    │  Worker Services  │
│   (Deployment)    │    │   (Deployment)    │    │   (Deployment)    │
│                   │    │                   │    │                   │
│  replicas: 3-10  │    │  replicas: 2-5   │    │  replicas: 3-8   │
│  HPA enabled     │    │  GPU nodes       │    │  HPA enabled     │
│                   │    │                   │    │                   │
└───────────────────┘    └───────────────────┘    └───────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│  StatefulSets                                                                │
│                                                                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │ PostgreSQL  │  │   Redis     │  │   Kafka     │  │   Qdrant    │        │
│  │  (HA)       │  │  Cluster    │  │  Cluster    │  │  Cluster    │        │
│  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────┘        │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

*架构设计遵循：高可用、可扩展、安全优先原则*
